<!DOCTYPE html>
<html lang="vi">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gi√°m s√°t ng·∫≠p ‚Äì IoT Flood System</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC2aoNSms-fOf0jjAeIwxmE-X1RfPlvEL4",
  authDomain: "tram-do-1.firebaseapp.com",
  databaseURL: "https://tram-do-1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tram-do-1"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
</script>

<script>
</script>



  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>

  <style>
/* =========================
   TO√ÄN B·ªò CSS GI·ªÆ NGUY√äN
   (KH√îNG R√öT G·ªåN ‚Äì KH√îNG S·ª¨A)
========================= */

/* ===== DISPLAY TOGGLE ===== */
.display-toggle {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.pill {
  flex: 1;
  max-width: 150px;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  background: #ffffff;
  text-align: center;
  transition: all 0.2s ease;
}
.pill-blue {
  color: #0284c7;
  border: 1.5px solid #0284c7;
}
.pill-blue.active {
  background: #0284c7;
  color: #ffffff;
}
.pill-red {
  color: #dc2626;
  border: 1.5px solid #dc2626;
}
.pill-red.active {
  background: #dc2626;
  color: #ffffff;
}

/* ================= MAP FULLSCREEN ================= */
.map-fullscreen {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  z-index: 2000 !important;
}
body.map-fullscreen-active {
  overflow: hidden;
}
body.map-fullscreen-active #sidebar,
body.map-fullscreen-active #historyPanel {
  display: none !important;
}

/* ================= ROOT ================= */
:root {
  --bg:#f5f6fa;
  --bg-card:#ffffff;
  --border-soft:#e5e7eb;
  --text-main:#1f2937;
  --text-sub:#6b7280;
  --safe:#4ade80;
  --light:#3b82f6;
  --medium:#f97316;
  --heavy:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family:Inter,system-ui;
}

/* ================= SIDEBAR ================= */
#sidebar{
  width:330px;
  height:100vh;
  position:fixed;
  top:0;
  left:0;
  background:#fff;
  border-right:1px solid var(--border-soft);
  padding:10px 12px 10px 14px;
  overflow-y:auto;
  z-index:1000;
  transition:width .25s ease;
}
#sidebarCollapseBtn{
  position:absolute;
  top:48px;
  right:-14px;
  width:30px;
  height:30px;
  border-radius:50%;
  background:#fff;
  border:1px solid #d1d5db;
  box-shadow:0 2px 4px rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:1100;
}

/* ================= MAP + HISTORY ================= */
#map{
  position:absolute;
  top:0;
  left:330px;
  right:0;
  bottom:230px;
  z-index:1;
}
/* ===== HISTORY CHEVRON ===== */
#historyToggleBtn {
  font-size: 0; /* ·∫©n text c≈© */
}

#historyToggleBtn .chevron {
  width: 10px;
  height: 10px;
  border-right: 2px solid #374151;
  border-bottom: 2px solid #374151;
  transform: rotate(45deg);   /* ‚ñº */
  transition: transform 0.25s ease;
  margin-top: 2px;
}

/* khi panel thu g·ªçn ‚Üí m≈©i t√™n quay l√™n */
#historyPanel.collapsed #historyToggleBtn .chevron {
  transform: rotate(-135deg); /* ‚ñ≤ */
}
#historyPanel{
  position:absolute;
  bottom:0;
  left:330px;
  right:0;
  min-height:260px;
  background:#fff;
  border-top:1px solid #e5e7eb;
  box-shadow:0 -2px 6px rgba(0,0,0,.06);
  padding:10px 14px;
  z-index:900;
}
#historyToggleBtn{
  position:absolute;
  top:-14px;
  left:50%;
  transform:translateX(-50%);
  width:36px;
  height:28px;
  background:#fff;
  border:1px solid #d1d5db;
  border-radius:0 0 10px 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:1001;
  box-shadow:0 -2px 6px rgba(0,0,0,.15);
  font-size:18px;
}

/* ================= BLINK ================= */
@keyframes sidebarBlinkYellow{
  0%,100%{box-shadow:0 0 0 rgba(250,204,21,0)}
  50%{box-shadow:0 0 0 4px rgba(250,204,21,.5)}
}
@keyframes sidebarBlinkOrange{
  0%,100%{background:#fff7ed}
  50%{background:#ffedd5}
}
@keyframes sidebarBlinkRed{
  0%,100%{background:#fee2e2}
  50%{background:#fecaca}
}
.sidebar-blink-ew{animation:sidebarBlinkYellow 2s infinite}
.sidebar-blink-lv2{animation:sidebarBlinkOrange 1.5s infinite}
.sidebar-blink-lv3{animation:sidebarBlinkRed 1s infinite}

/* ================= MOBILE ================= */
@media(max-width:768px){
  #sidebar{position:relative;width:100%;height:auto}
  #map{position:relative;left:0;height:50vh;bottom:auto}
  #historyPanel{position:relative;left:0}
  #sidebarCollapseBtn{display:none}
}
/* ===== FIX: HISTORY PANEL KH√îNG CHI·∫æM FULL M√ÄN ===== */
#historyPanel {
  max-height: 42vh;          /* desktop: t·ªëi ƒëa 42% m√†n h√¨nh */
  overflow-y: auto;          /* cu·ªôn b√™n trong */
}

/* Mobile */
@media (max-width: 768px) {
  #historyPanel {
    max-height: 55vh;        /* mobile cho cao h∆°n ch√∫t */
  }
}
/* ================= SIDEBAR COLLAPSED FIX ================= */
#sidebar.collapsed {
  width: 56px;                /* sidebar thu g·ªçn */
  padding-left: 6px;
  padding-right: 6px;
}

#sidebar.collapsed .sidebar-inner {
  display: none;              /* ·∫©n to√†n b·ªô n·ªôi dung */
}

/* map & history d·ªãch theo sidebar */
#map.sidebar-collapsed {
  left: 56px !important;
}

#historyPanel.sidebar-collapsed {
  left: 56px !important;
}

/* n√∫t collapse xoay chi·ªÅu */
#sidebar.collapsed #sidebarCollapseBtn {
  transform: rotate(180deg);
}

  </style>

</head>

<body>
<!-- ================= SIDEBAR ================= -->
<div id="sidebar">
  <div id="sidebarCollapseBtn" onclick="toggleSidebar()">‚û§</div>

  <div class="sidebar-inner">

    <div style="display:flex;gap:8px;margin-bottom:6px">
      <img src="logoUDC.gif" style="width:60px;height:60px;border-radius:50%">
      <div>
        <div style="font-size:15px;font-weight:700;color:#0ea5e9">
          C√îNG TY TNHH MTV THO√ÅT N∆Ø·ªöC ƒê√î TH·ªä TP. H·ªí CH√ç MINH
        </div>
        <div style="font-size:13px;color:#0ea5e9">
          Tr·∫°m c·∫£m bi·∫øn b√°o ng·∫≠p v√† tri·ªÅu
        </div>
      </div>
    </div>
<div style="margin-top:12px;">
  <button id="logoutBtn" onclick="logout()">
    ƒêƒÉng xu·∫•t
  </button>
</div>
    <input id="stationSearch"
           placeholder="T√¨m tr·∫°m theo t√™n ho·∫∑c ID..."
           oninput="searchStation(this.value)" />

    <!-- Network -->
    <div class="networkStatusBox">
      <div style="font-weight:600;margin-bottom:8px">
        Tr·∫°ng th√°i m·∫°ng l∆∞·ªõi
      </div>
      <div class="networkStatusItem">
        <span>Thi·∫øt b·ªã Online:</span>
        <span id="netOnline" class="net-online">0</span>
      </div>
      <div class="networkStatusItem">
        <span>Thi·∫øt b·ªã M·∫•t k·∫øt n·ªëi:</span>
        <span id="netOffline" class="net-offline">0</span>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="sidebar-dashboard">
      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">T·ªïng tr·∫°m</div>
        <div class="sidebar-dashboard-value" id="dbTotalStations">0</div>
      </div>
      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">Kh√¥ng ng·∫≠p</div>
        <div class="sidebar-dashboard-value" id="dbLevel0">0</div>
      </div>
      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">Ng·∫≠p nh·∫π</div>
        <div class="sidebar-dashboard-value" id="dbLevel1">0</div>
      </div>
      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">Ng·∫≠p v·ª´a</div>
        <div class="sidebar-dashboard-value" id="dbLevel2">0</div>
      </div>
      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">Ng·∫≠p n·∫∑ng</div>
        <div class="sidebar-dashboard-value" id="dbLevel3">0</div>
      </div>
    </div>

    <div class="sidebar-section-title">Ch·∫ø ƒë·ªô hi·ªÉn th·ªã</div>
    <div class="display-toggle">
      <div id="toggleHeatmapBtn" class="pill pill-blue"
           onclick="toggleHeatmap()">B·∫≠t Heatmap ng·∫≠p</div>
      <div id="toggleDangerBtn" class="pill pill-red"
           onclick="toggleDangerFilter()">Tr·∫°m b√°o ng·∫≠p</div>
    </div>

    <div class="sidebar-section-title">Danh s√°ch tr·∫°m</div>
    <div id="stationList"></div>


  </div>
</div>

<!-- ================= MAP ================= -->
<div id="map"></div>
<div id="mapFullscreenBtn"
     onclick="toggleMapFullscreen()"
     style="position:absolute;top:10px;right:10px;z-index:1600">
  ‚õ∂
</div>

<!-- ================= HISTORY ================= -->
<div id="historyPanel">
<div id="historyToggleBtn" onclick="toggleHistoryPanel()">
  <span class="chevron"></span>
</div>
  <div id="historyContent"></div>
</div>

<!-- ====== SCRIPT LIBRARIES (JS LOGIC S·∫º ·ªû PART 2) ====== -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<!-- =========================
  (B·ªî SUNG CSS C√íN THI·∫æU ƒê·ªÇ GI·ªÆ UI 100%)
  V√¨ PART 1 ƒë√£ ch∆∞a ch·ª©a ƒë·ªß to√†n b·ªô CSS nh∆∞ b·∫£n b·∫°n g·ª≠i,
  n√™n PART 2 n√†y b·ªï sung PH·∫¶N CSS C√íN L·∫†I (KH√îNG ƒê·ªîI UI)
========================= -->
<style>
/* ====== C√°c class UI b·∫°n ƒëang d√πng (gi·ªØ nguy√™n) ====== */

#stationSearch {
  margin-top: 10px;
  width: 100%;
  padding: 7px 14px;
  border-radius: 20px;
  border: 1px solid #d1d5db;
  outline: none;
  font-size: 13px;
  margin-bottom: 5px;
}
#stationSearch:focus { border-color: #0ea5e9; }

.sidebar-section-title {
  font-size: 13px;
  font-weight: 600;
  margin: 10px 0 6px;
  color: #374151;
}

.sidebar-dashboard {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  margin-top: 6px;
  margin-bottom: 10px;
}

/* Dashboard card (gi·ªØ nguy√™n nh∆∞ code b·∫°n g·ª≠i ‚Äì c√≥ 2 block, m√¨nh gi·ªØ block ‚Äúcu·ªëi‚Äù v√¨ n√≥ ƒëang override trong file b·∫°n) */
.sidebar-dashboard-card {
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 10px 12px;
  box-shadow: inset 0 0 4px rgba(0,0,0,0.03);
}
.sidebar-dashboard-label {
  color: #6b7280;
  font-size: 12px;
  font-weight: 500;
}
.sidebar-dashboard-value {
  font-size: 18px;
  font-weight: 700;
  margin-top: 4px;
}

/* block override nh∆∞ b·∫°n c√≥ (m√¨nh gi·ªØ ƒë√∫ng th·ª© t·ª± override) */
.sidebar-dashboard-card {
  background: #f5f5f5;
  border-radius: 14px;
  padding: 5px;
  border: none;
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,0.6),
    inset 0 -1px 2px rgba(0,0,0,0.05);
}

.networkStatusBox {
  margin-top: 1px;
  margin-bottom: 6px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  padding: 8px 10px;
  border-radius: 10px;
  font-size: 13px;
}
.networkStatusItem {
  display:flex;
  justify-content:space-between;
  margin:2px 0;
  font-size:13px;
}
.net-online { color:#16a34a; font-weight:600; }
.net-offline { color:#dc2626; font-weight:600; }

.station-item {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 8px 10px;
  margin-bottom: 6px;
  cursor: pointer;
}
.station-item:hover { background:#f0f9ff; }
.station-name { font-size: 14px; font-weight: 600; }
.station-id { font-size: 11px; color: #6b7280; margin-bottom: 3px; }
.chip { font-size: 13px; display:flex; gap:4px; align-items:center; }

.status-safe   { color: #4ade80; }
.status-light  { color: #3b82f6; }
.status-medium { color: #f97316; }
.status-heavy  { color: #ef4444; }

/* popup */
.popup-card {
  width: 260px;
  background:#ffffff;
  border-radius: 12px;
  padding: 12px;
  font-size: 13px;
  color:#111827;
}
.popup-title { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
.popup-sub { font-size: 12px; color: #6b7280; margin-bottom: 8px; }
.popup-row { margin-bottom: 4px; }
.popup-link {
  display:block;
  margin-top:6px;
  font-size:13px;
  color:#2563eb;
  text-decoration:none;
  font-weight:600;
}

/* marker 3d */
.dyn-marker-outer {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background:#ffffff;
  border: 2px solid rgba(0,0,0,0.25);
  box-shadow: 0 0 8px rgba(0,0,0,0.35);
  display:flex;
  align-items:center;
  justify-content:center;
}
.dyn-marker-inner {
  width: 18px;
  height: 18px;
  border-radius: 50%;
}
@keyframes pulseBlink {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.25); opacity: 0.6; }
  100% { transform: scale(1); opacity: 1; }
}

/* history layout */
.history-flex {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 8px;
}
.history-right {
  width: 250px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  font-size: 15px;
}
.history-toolbar {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}
.history-select {
  min-width: 220px;
  padding: 7px 12px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 13px;
  background: #ffffff;
}
.history-date {
  padding: 7px 12px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 13px;
  background: #ffffff;
}
.btn-primary {
  padding: 7px 16px;
  border-radius: 10px;
  border: none;
  background: #0ea5e9;
  color: #ffffff;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}
.btn-primary:hover { background: #0284c7; }

.btn-outline-blue {
  padding: 7px 14px;
  border-radius: 10px;
  border: 1px solid #2563eb;
  background: #ffffff;
  color: #2563eb;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}
.btn-outline-blue:hover { background: #eff6ff; }

.btn-outline-red {
  padding: 7px 14px;
  border-radius: 10px;
  border: 1px solid #dc2626;
  background: #ffffff;
  color: #dc2626;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}
.btn-outline-red:hover { background: #fef2f2; }

/* history chart fix */
#historyChart {
  height: 200px !important;   /* desktop */
  max-height: 200px;
}

@media (max-width: 768px) {
  #historyChart {
    height: 180px !important;
  }
}
/* collapsed history panel */
#historyPanel.collapsed {
  height: 36px !important;
  min-height: 36px !important;
  max-height: 36px !important;
  overflow: hidden;
}
#historyPanel.collapsed .history-flex { display: none; }

/* mobile fixes */
@media (max-width: 768px) {
  .display-toggle { flex-direction: column; gap: 10px; }
  .pill { max-width: 100%; }

  .history-flex { flex-direction: column; }
  .history-right { width: 100%; }

  .history-select, .history-date,
  .btn-primary, .btn-outline-blue, .btn-outline-red {
    width: 100%;
  }

  .sidebar-dashboard { grid-template-columns: repeat(2, 1fr); gap: 6px; }
  .sidebar-dashboard-value { font-size: 16px; }
  .station-name { font-size: 13px; }
  .chip { font-size: 12px; }

  .popup-card {
    width: 220px;
    max-height: 70vh;
    overflow-y: auto;
    padding: 14px;
    font-size: 14px;
  }
}

/* fullscreen btn style (gi·ªØ ƒë√∫ng nh∆∞ b·∫°n c√≥) */
@media (max-width: 768px) {
  #mapFullscreenBtn {
    top: 12px;
    right: 12px;
    font-size: 16px;
    padding: 8px 12px;
  }
}
@media print { #mapFullscreenBtn { display:none !important; } }
#logoutBtn{
  width:100%;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #dc2626;
  background:#ffffff;
  color:#dc2626;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
}
#logoutBtn:hover{
  background:#fef2f2;
}


</style>

<script>
/* ============================
   FIREBASE CONFIG
============================ */

/* ============================
   BI·∫æN TO√ÄN C·ª§C
============================ */
let map;
let markers = {};
let currentStations = {};
let activeStationId = null;

let dangerOnly = false;
let heatmapEnabled = false;
let heatLayer = null;

let historyCollapsed = false;
let historyChartInstance = null;

let mapFullscreen = false;

/* ============================
   RULE TR·∫†M NGUY HI·ªÇM
============================ */
function isDangerStation(s) {
  const level = Number(s.flood_level ?? 0);
  const ew    = Number(s.early_warning ?? 0) === 1;
  return ew || level >= 2;
}

/* ============================
   TOGGLE: CH·ªà TR·∫†M C·∫¢NH B√ÅO
============================ */
function toggleDangerFilter() {
  dangerOnly = !dangerOnly;

  const btn = document.getElementById("toggleDangerBtn");
  if (btn) {
    btn.textContent = dangerOnly ? "ƒêang l·ªçc: Tr·∫°m c·∫£nh b√°o" : "Tr·∫°m b√°o ng·∫≠p";
    btn.classList.toggle("active", dangerOnly);
  }

  buildSidebar(currentStations);

  Object.entries(currentStations).forEach(([id, s]) => {
    const shouldShow = !dangerOnly || isDangerStation(s);
    if (markers[id]) {
      if (shouldShow) markers[id].addTo(map);
      else map.removeLayer(markers[id]);
    }
  });

  if (heatmapEnabled) buildHeatmap();
}

/* ============================
   SIDEBAR COLLAPSE
============================ */
function toggleSidebar() {
  const sb = document.getElementById("sidebar");
  const mp = document.getElementById("map");
  const hp = document.getElementById("historyPanel");

  if (!sb || !mp || !hp) return;

  sb.classList.toggle("collapsed");
  mp.classList.toggle("sidebar-collapsed");
  hp.classList.toggle("sidebar-collapsed");

  setTimeout(() => {
    if (map) map.invalidateSize();
  }, 250);
}

/* ============================
   HISTORY PANEL TOGGLE
============================ */
function toggleHistoryPanel() {
  const panel = document.getElementById("historyPanel");
  const btn   = document.getElementById("historyToggleBtn");
  const mapEl = document.getElementById("map");

  historyCollapsed = !historyCollapsed;

  if (historyCollapsed) {
    panel.classList.add("collapsed");
    btn.textContent = "‚åÉ";
    mapEl.style.bottom = "36px";   // üëà TH√äM D√íNG N√ÄY
  } else {
    panel.classList.remove("collapsed");
    btn.textContent = "‚åÑ";
    mapEl.style.bottom = "230px";  // üëà V√Ä D√íNG N√ÄY
  }

  setTimeout(() => map.invalidateSize(), 300);
}
/* ============================
   MAP INIT
============================ */
function initMap() {
  map = L.map("map").setView([10.7756, 106.7009], 12);

  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);
}

/* ============================
   MAP FULLSCREEN
============================ */
function toggleMapFullscreen() {
  const mapDiv = document.getElementById("map");
  const btn    = document.getElementById("mapFullscreenBtn");
  if (!mapDiv || !btn) return;

  mapFullscreen = !mapFullscreen;

  if (mapFullscreen) {
    document.body.classList.add("map-fullscreen-active");
    mapDiv.classList.add("map-fullscreen");
    btn.textContent = "‚úï";
  } else {
    document.body.classList.remove("map-fullscreen-active");
    mapDiv.classList.remove("map-fullscreen");
    btn.textContent = "‚õ∂";
  }

setTimeout(() => {
  if (window.map) {
    map.invalidateSize();
  }
}, 300);
}

/* ============================
   ONLINE/OFFLINE
============================ */
function isStationOnline(s) {
  let raw = Number(s.last_update ?? 0);
  if (!raw || isNaN(raw)) return false;

  let lastMs;
  if (raw > 1e12) lastMs = raw;
  else if (raw > 1e9) lastMs = raw * 1000;
  else return true; // uptime -> coi nh∆∞ online

  const diff = Date.now() - lastMs;
  return diff <= 2 * 60 * 1000;
}

/* ============================
   STATUS
============================ */
function makeStatus(levelRaw) {
  const level = Number(levelRaw ?? 0);
  if (level === 0) return { label: "Kh√¥ng ng·∫≠p", className: "status-safe" };
  if (level === 1) return { label: "Ng·∫≠p nh·∫π", className: "status-light" };
  if (level === 2) return { label: "Ng·∫≠p v·ª´a", className: "status-medium" };
  if (level >= 3) return { label: "Ng·∫≠p n·∫∑ng", className: "status-heavy" };
  return { label: "Kh√¥ng x√°c ƒë·ªãnh", className: "status-safe" };
}
function levelIcon(levelRaw) {
  const level = Number(levelRaw ?? 0);
  if (level === 0) return "üíß";
  if (level === 1) return "üåä";
  if (level === 2) return "üåä";
  return "üö®";
}
function levelColor(levelRaw) {
  const level = Number(levelRaw ?? 0);
  if (level === 0) return "#4CAF50";
  if (level === 1) return "#0284c7";
  if (level === 2) return "#f97316";
  return "#ef4444";
}

/* ============================
   MARKER 3D
============================ */
function makeMarkerHtml(s) {
  const level = Number(s.flood_level ?? 0);
  const rise  = Number(s.rise_rate ?? 0);
  const color = levelColor(level);

  let outerStyle = "";
  let innerStyle = `background:${color};`;

  if (rise > 0.1 && level > 0) outerStyle = "animation:pulseBlink 1.4s infinite;";
  if (level >= 3) outerStyle = "animation:pulseBlink 0.9s infinite;";

  return `
    <div class="dyn-marker-outer" style="${outerStyle}">
      <div class="dyn-marker-inner" style="${innerStyle}"></div>
    </div>
  `;
}

function createOrUpdateMarker(id, s) {
  if (!s || !s.lat || !s.lng) return;

  const html = makeMarkerHtml(s);
  const icon = L.divIcon({
    html,
    className: "",
    iconSize: [26, 26],
    iconAnchor: [13, 13]
  });

  const latlng = [s.lat, s.lng];

  if (!markers[id]) {
    markers[id] = L.marker(latlng, { icon }).addTo(map);
    markers[id].on("click", () => showStationPopup(id));
  } else {
    markers[id].setLatLng(latlng);
    markers[id].setIcon(icon);
  }
}

/* ============================
   POPUP
============================ */
function showStationPopup(id) {
  const s = currentStations[id];
  if (!s) return;
  activeStationId = id;

  const level = Number(s.flood_level ?? 0);

  // ===== X·ª¨ L√ù NGHI·ªÜP V·ª§ =====
  let road = 0;
  let dur  = 0;
  let over = false;

  if (level > 0) {
    road = Number(s.road_flood ?? s.water_level ?? 0);
    dur  = Number(s.flood_duration ?? 0);
    over = Number(s.over_sidewalk ?? 0) === 1;
  }

  const rise = Number(s.rise_rate ?? 0);
  const fall = Number(s.fall_rate ?? 0);

  // Quy t·∫Øc hi·ªÉn th·ªã
  const showRise = level > 0 && rise > 0.01;
  const showFall = level >= 2 && fall > 0.01;

  const html = `
    <div class="popup-card">
      <div class="popup-title">${s.name || id}</div>
      <div class="popup-sub">${s.address || ""}</div>

      <!-- KH·ªêI TR·∫†NG TH√ÅI NG·∫¨P -->
      <div style="
        background:#eef7ff;
        border:1px solid #cfe3ff;
        padding:10px;
        border-radius:12px;
        margin-bottom:10px;
      ">
        <div style="font-size:22px; font-weight:700; color:${levelColor(level)};">
          ${
            level === 0
              ? "Kh√¥ng ng·∫≠p"
              : `${road.toFixed(1)} cm`
          }
        </div>

        <div style="font-size:14px; color:${levelColor(level)};">
          ${levelIcon(level)}
          ${
            level === 0
              ? "Kh√¥ng ng·∫≠p m·∫∑t ƒë∆∞·ªùng"
              : "Ng·∫≠p m·∫∑t ƒë∆∞·ªùng"
          }
        </div>
      </div>

      <!-- CHI TI·∫æT -->
      <div class="popup-row">
        üü• Tr√†n l·ªÅ:
        <b style="color:${over ? "#ef4444" : "#16a34a"};">
          ${over ? "C√≥" : "Kh√¥ng"}
        </b>
      </div>

      ${
        showRise
          ? `<div class="popup-row">üìà D√¢ng: <b>${rise.toFixed(2)} cm/ph√∫t</b></div>`
          : ""
      }

      ${
        showFall
          ? `<div class="popup-row">üìâ R√∫t: <b>${fall.toFixed(2)} cm/ph√∫t</b></div>`
          : ""
      }

      <div class="popup-row">
        ‚è± Th·ªùi gian ng·∫≠p:
        <b>${dur.toFixed(1)} ph√∫t</b>
      </div>

      <a class="popup-link" target="_blank"
         href="https://maps.google.com/?q=${s.lat},${s.lng}">
        üìç Xem Camera tr·ª±c ti·∫øp
      </a>
    </div>
  `;

  markers[id].unbindPopup();
  markers[id].bindPopup(html).openPopup();
}

/* ============================
   SIDEBAR RENDER + DASHBOARD
============================ */
function buildSidebar(stationsMap) {
  const list = document.getElementById("stationList");
  if (!list) return;

  list.innerHTML = "";

  let total = 0;
  let c0=0,c1=0,c2=0,c3=0;
  let online=0, offline=0;

  Object.entries(stationsMap).forEach(([id, s]) => {
    if (dangerOnly && !isDangerStation(s)) return;
    total++;

    const level = Number(s.flood_level ?? 0);
    if (level === 0) c0++;
    else if (level === 1) c1++;
    else if (level === 2) c2++;
    else if (level >= 3) c3++;

    const on = isStationOnline(s);
    if (on) online++; else offline++;

    const st  = makeStatus(level);
    const wl  = Number(s.water_level ?? 0);
    const ew  = Number(s.early_warning ?? 0) === 1;

    const div = document.createElement("div");
    div.className = "station-item";

    if (ew && level < 3) div.classList.add("sidebar-blink-ew");
    else if (level === 2) div.classList.add("sidebar-blink-lv2");
    else if (level >= 3) div.classList.add("sidebar-blink-lv3");

    div.onclick = () => showStationPopup(id);

    div.innerHTML = `
      <div class="station-name">${s.name || id}</div>
      <div class="station-id">
        ${id} ‚Ä¢ ${
          on
            ? '<span class="net-online">üü¢ Online</span>'
            : '<span class="net-offline">üî¥ M·∫•t k·∫øt n·ªëi</span>'
        }
      </div>

      <div class="chip" style="margin-top:4px;">
        ${levelIcon(level)}
        <b>${Number(s.road_flood ?? wl).toFixed(1)} cm</b>
        ‚Äî <span class="${st.className}">${st.label}</span>
      </div>
    `;

    /* gi·ªØ ƒë√∫ng style inline b·∫°n c√≥ */
    div.style.background = "rgba(3,169,244,0.06)";
    div.style.border = "1px solid #d0e7ff";

    list.appendChild(div);
  });

  const setText = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.textContent = String(val);
  };

  setText("dbTotalStations", total);
  setText("dbLevel0", c0);
  setText("dbLevel1", c1);
  setText("dbLevel2", c2);
  setText("dbLevel3", c3);

  setText("netOnline", online);
  setText("netOffline", offline);
}

/* ============================
   HEATMAP
============================ */
function toggleHeatmap() {
  heatmapEnabled = !heatmapEnabled;

  const btn = document.getElementById("toggleHeatmapBtn");
  if (btn) {
    btn.textContent = heatmapEnabled ? "T·∫Øt Heatmap ng·∫≠p" : "B·∫≠t Heatmap ng·∫≠p";
    btn.classList.toggle("active", heatmapEnabled);
  }

  if (heatmapEnabled) buildHeatmap();
  else {
    if (heatLayer) {
      map.removeLayer(heatLayer);
      heatLayer = null;
    }
  }
}

function buildHeatmap() {
  if (!window.L || !map) return;

  const points = [];

  Object.values(currentStations).forEach(s => {
    if (!s.lat || !s.lng) return;
    const road = Number(s.road_flood ?? 0);
    if (road <= 0) return;
    points.push([s.lat, s.lng, road]);
  });

  if (heatLayer) map.removeLayer(heatLayer);

  heatLayer = L.heatLayer(points, {
    radius: 30,
    blur: 20,
    maxZoom: 17,
  });

  heatLayer.addTo(map);
}

/* ============================
   FETCH STATIONS (REALTIME)
============================ */
function fetchStations() {
  firebase.database().ref("stations").on("value", snap => {
    const data = snap.val() || {};
    currentStations = data;

    buildSidebar(data);

    Object.entries(data).forEach(([id, s]) => {
      createOrUpdateMarker(id, s);
    });

    if (activeStationId && markers[activeStationId]) {
      markers[activeStationId].closePopup();
      showStationPopup(activeStationId);
      markers[activeStationId].openPopup();
    }

    if (typeof updateHistoryStationDropdown === "function") {
      updateHistoryStationDropdown();
    }

    if (heatmapEnabled) buildHeatmap();
  });
}

/* ============================
   SEARCH STATION
============================ */
function searchStation(keyword) {
  keyword = (keyword || "").toLowerCase();
  const list = document.getElementById("stationList");
  if (!list) return;
  list.innerHTML = "";

  Object.entries(currentStations).forEach(([id, s]) => {
    const name = (s.name || "").toLowerCase();
    if (!keyword || name.includes(keyword) || id.toLowerCase().includes(keyword)) {

      if (dangerOnly && !isDangerStation(s)) return;

      const level = Number(s.flood_level ?? 0);
      const st    = makeStatus(level);
      const wl    = Number(s.water_level ?? 0);
      const on    = isStationOnline(s);
      const ew    = Number(s.early_warning ?? 0) === 1;

      const div = document.createElement("div");
      div.className = "station-item";

      if (ew && level < 3) div.classList.add("sidebar-blink-ew");
      else if (level === 2) div.classList.add("sidebar-blink-lv2");
      else if (level >= 3) div.classList.add("sidebar-blink-lv3");

      div.onclick = () => showStationPopup(id);

      div.innerHTML = `
        <div class="station-name">${s.name || id}</div>
        <div class="station-id">
          ${id} ‚Ä¢ ${
            on
              ? '<span class="net-online">üü¢ Online</span>'
              : '<span class="net-offline">üî¥ M·∫•t k·∫øt n·ªëi</span>'
          }
        </div>
        <div class="chip">
          ${levelIcon(level)}
          <b>${Number(s.road_flood ?? wl).toFixed(1)} cm</b>
          ‚Äî <span class="${st.className}">${st.label}</span>
        </div>
      `;

      list.appendChild(div);
    }
  });
}

/* ============================
   HISTORY UI (ƒë√∫ng nh∆∞ b·∫°n g·ª≠i)
============================ */
function initHistoryUI() {
  const host = document.getElementById("historyContent");
  if (!host) return;

  host.innerHTML = `
    <div class="history-flex">

      <div style="flex:1; min-width:0;">
        <div class="history-toolbar">
          <select id="historyStationSelect" class="history-select"></select>
          <input type="date" id="historyDate" class="history-date" />
          <button class="btn-primary" onclick="loadHistory()">Xem l·ªãch s·ª≠</button>
          <button class="btn-outline-blue" onclick="exportHistoryCSV()">CSV</button>
          <button class="btn-outline-red" onclick="exportHistoryPDF()">PDF</button>
        </div>
        <canvas id="historyChart"></canvas>
      </div>

      <div id="historyStatsCard" class="history-right">
        <div style="font-weight:700; margin-bottom:6px;">
          üìå Th·ªëng k√™ ng·∫≠p trong ng√†y
        </div>
        <div id="multiEventContainer"></div>
        <div id="statAvgDepth" style="margin-top:6px;"></div>
        <div id="statFloodDuration" style="margin-top:3px;"></div>
      </div>

    </div>
  `;
}

/* dropdown tr·∫°m */
function updateHistoryStationDropdown() {
  const sel = document.getElementById("historyStationSelect");
  if (!sel) return;

  const cur = sel.value;
  sel.innerHTML = "";

  Object.entries(currentStations).forEach(([id, s]) => {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${s.name || id} (${id})`;
    sel.appendChild(opt);
  });

  if (cur) sel.value = cur;
}

/* load l·ªãch s·ª≠ */
function loadHistory() {
  const id   = document.getElementById("historyStationSelect")?.value;
  const date = document.getElementById("historyDate")?.value;
  if (!id || !date) return;

  firebase.database().ref(`history/${id}/${date}`).once("value", snap => {
    const data = snap.val() || {};
    drawHistoryChart(data);
    computeHistoryStats(data);
  });
}

/* v·∫Ω chart */
function drawHistoryChart(data) {
  const labels = [];
  const values = [];

  Object.entries(data).forEach(([t, r]) => {
    labels.push(t);
    values.push(Number(r.water_level ?? 0));
  });

  const canvas = document.getElementById("historyChart");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  if (historyChartInstance) historyChartInstance.destroy();

  historyChartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "M·ª±c n∆∞·ªõc (cm)",
        data: values,
        borderColor: "#2563eb",
        backgroundColor: "rgba(37,99,235,0.15)",
        borderWidth: 2,
        tension: 0.35,
        pointRadius: 2,
        pointHoverRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        y: { beginAtZero: true, ticks: { padding: 6 } },
        x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 } }
      },
      layout: { padding: { top: 10, bottom: 10, left: 6, right: 6 } }
    }
  });
}

/* stats ƒëa ƒë·ª£t */
function computeHistoryStats(data) {
  const entries = Object.entries(data);
  if (entries.length === 0) return showNoFlood();

  let events = [];
  let cur = null;
  let totalDepth = 0;
  let countDepth = 0;

  entries.forEach(([time, rec]) => {
    const wl = Number(rec.water_level ?? 0);

    if (wl > 0) {
      totalDepth += wl;
      countDepth++;
      if (!cur) cur = { start: time, end: time, maxDepth: wl };
      else {
        cur.end = time;
        cur.maxDepth = Math.max(cur.maxDepth, wl);
      }
    } else {
      if (cur) { events.push(cur); cur = null; }
    }
  });

  if (cur) events.push(cur);
  if (events.length === 0) return showNoFlood();

  let totalMinutes = 0;
  events.forEach(ev => totalMinutes += eventDurationMinutes(ev.start, ev.end));

  const avg = totalDepth / (countDepth || 1);
  displayFloodStats(events, avg, totalMinutes);
}

function eventDurationMinutes(t1, t2) {
  const [h1, m1] = t1.split(":").map(Number);
  const [h2, m2] = t2.split(":").map(Number);
  return (h2*60 + m2) - (h1*60 + m1);
}

function displayFloodStats(events, avgDepth, totalMinutes) {
  const container = document.getElementById("multiEventContainer");
  const avgEl = document.getElementById("statAvgDepth");
  const durEl = document.getElementById("statFloodDuration");
  if (!container || !avgEl || !durEl) return;

  container.innerHTML = "";

  events.forEach((ev, idx) => {
    container.innerHTML += `
      <div style="margin-bottom:6px;">
        <b>ƒê·ª£t ${idx+1}:</b> ${ev.start} ‚Üí ${ev.end}<br>
        ƒê·ªô s√¢u l·ªõn nh·∫•t: <b>${ev.maxDepth} cm</b>
      </div>
    `;
  });

  avgEl.innerHTML = `ƒê·ªô s√¢u trung b√¨nh: <b>${avgDepth.toFixed(1)} cm</b>`;
  durEl.innerHTML = `Th·ªùi gian ng·∫≠p li√™n t·ª•c: <b>${totalMinutes.toFixed(1)} ph√∫t</b>`;
}

function showNoFlood() {
  const container = document.getElementById("multiEventContainer");
  const avgEl = document.getElementById("statAvgDepth");
  const durEl = document.getElementById("statFloodDuration");
  if (container) container.innerHTML = `<i>Kh√¥ng c√≥ ƒë·ª£t m∆∞a/ng·∫≠p trong ng√†y.</i>`;
  if (avgEl) avgEl.innerHTML = "";
  if (durEl) durEl.innerHTML = "";
}

/* export CSV */
function exportHistoryCSV() {
  const id   = document.getElementById("historyStationSelect")?.value;
  const date = document.getElementById("historyDate")?.value;
  if (!id || !date) return;

  firebase.database().ref(`history/${id}/${date}`).once("value", snap => {
    const data = snap.val() || {};

    let csv = "time,water_level,road_flood,rise_rate,fall_rate\n";
    Object.entries(data).forEach(([t,r]) => {
      csv += `${t},${r.water_level ?? 0},${r.road_flood ?? 0},${r.rise_rate ?? 0},${r.fall_rate ?? 0}\n`;
    });

    const blob = new Blob([csv], { type:"text/csv" });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href = url;
    a.download = `history_${id}_${date}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });
}

/* export PDF */
async function exportHistoryPDF() {
  const { jsPDF } = window.jspdf;

  const panel = document.getElementById("historyPanel");
  if (!panel) return;

  const stationSelect = document.getElementById("historyStationSelect");
  const stationText = stationSelect?.selectedOptions[0]?.text || "Tram";
  const stationId = stationSelect?.value || "station";

  const dateVal = document.getElementById("historyDate")?.value || "";
  const [y, m, d] = dateVal.split("-");
  const dateStr = d && m && y ? `${d}-${m}-${y}` : "Ngay";

  const clean = s =>
    s.normalize("NFD")
     .replace(/[\u0300-\u036f]/g, "")
     .replace(/[^a-zA-Z0-9]/g, "_");

  const fileName = `BC_NgapNuoc_${clean(stationText)}_${clean(stationId)}_Ngay_${dateStr}.pdf`;

  const canvas = await html2canvas(panel, {
    scale: 2,
    useCORS: true,
    backgroundColor: "#ffffff"
  });

  const imgData = canvas.toDataURL("image/png");

  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = 210;
  const pageHeight = 297;

  const imgWidth = pageWidth - 20;
  const imgHeight = canvas.height * imgWidth / canvas.width;

  let yPos = 10;
  pdf.addImage(imgData, "PNG", 10, yPos, imgWidth, imgHeight);

  let heightLeft = imgHeight - (pageHeight - 20);
  while (heightLeft > 0) {
    pdf.addPage();
    yPos = -heightLeft + 10;
    pdf.addImage(imgData, "PNG", 10, yPos, imgWidth, imgHeight);
    heightLeft -= pageHeight - 20;
  }

  pdf.save(fileName);
}

/* ============================
   HOTKEY (F / ESC) ‚Äì ch·ªâ add 1 l·∫ßn
============================ */
document.addEventListener("keydown", function (e) {
  const tag = document.activeElement?.tagName;
  if (tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT") return;

  if (e.key === "f" || e.key === "F") {
    e.preventDefault();
    toggleMapFullscreen();
  }

  if (e.key === "Escape") {
    if (mapFullscreen) {
      e.preventDefault();
      toggleMapFullscreen();
    }
  }
});

/* ============================
   INIT
============================ */
firebase.auth().onAuthStateChanged(user=>{
  if(!user){
    window.location.replace("login.html");
    return;
  }

  initHistoryUI();
  initMap();
  fetchStations();

  
  const dateInput = document.getElementById("historyDate");
  if (dateInput && !dateInput.value) {
    const today = new Date();
    dateInput.value = today.toISOString().slice(0,10);
  }

  updateHistoryStationDropdown();
});

/* Service Worker */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("/sw.js")
    .catch(err => console.warn("Service Worker ƒëƒÉng k√Ω l·ªói:", err));
}
</script>
<script>
function logout(){
  firebase.auth().signOut()
    .then(()=>{
      window.location.replace("login.html");
    })
    .catch(err=>{
      alert("Logout l·ªói: " + err.message);
    });
}
</script>
</body>
</html>


