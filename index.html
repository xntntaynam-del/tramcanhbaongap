<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tr·∫°m c·∫£m bi·∫øn b√°o ng·∫≠p ‚Äì Realtime</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    * { box-sizing: border-box; }

    /* ======================
       THEME VARIABLES
    ====================== */
    :root {
      --bg-main: #050816;
      --bg-sidebar: #0b1220;
      --bg-topbar: rgba(15,23,42,0.95);
      --bg-card: rgba(15,23,42,0.92);
      --bg-chip: rgba(15,23,42,0.9);
      --border-soft: rgba(148,163,184,0.3);
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --accent-blue: #3b82f6;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.6);
    }

    body[data-theme="light"] {
      --bg-main: #f5f7fb;
      --bg-sidebar: #f9fafb;
      --bg-topbar: #ffffff;
      --bg-card: #ffffff;
      --bg-chip: #f3f4f6;
      --border-soft: rgba(148,163,184,0.5);
      --text-main: #111827;
      --text-sub: #6b7280;
      --accent-blue: #007aff;
      --accent-green: #16a34a;
      --accent-red: #dc2626;
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.15);
    }

    /* BODY + LAYOUT */
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      overflow: hidden;
    }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      height: 100vh;
      transition: grid-template-columns .25s ease-out;
      position: relative;
    }

    .layout.sidebar-collapsed {
      grid-template-columns: 0 1fr;
    }

    /* SIDEBAR */
    #sidebar {
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-soft);
      display: flex; flex-direction: column;
      padding: 16px; gap: 12px;
      overflow-y: auto;
      transition: .25s;
    }

    .brand { font-size: 18px; font-weight: 700; }
    .subtitle { font-size: 12px; color: var(--text-sub); }
    .search-box {
      width: 100%; padding: 8px 10px; border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,0.1);
      color: var(--text-main);
    }

    .sidebar-section-title {
      font-size: 11px; text-transform: uppercase;
      color: var(--text-sub);
      margin-top: 10px;
    }

    .station-list { flex: 1; overflow-y: auto; }

    .station-item {
      background: var(--bg-card);
      padding: 10px; border-radius: 14px;
      margin-bottom: 8px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      border: 1px solid transparent;
    }

    .station-item:hover { border-color: var(--accent-blue); }
    .station-item.active { border-color: var(--accent-blue); }

    .chip {
      display: inline-flex; align-items: center;
      padding: 3px 8px; font-size: 11px;
      border-radius: 999px;
      background: var(--bg-chip);
      border: 1px solid var(--border-soft);
      margin-top: 6px;
    }

    /* SIDEBAR TOGGLE */
    #sidebarToggle {
      position: absolute;
      top: 50%; left: 320px; transform: translateY(-50%);
      width: 24px; height: 60px;
      background: var(--bg-topbar);
      border-radius: 0 999px 999px 0;
      border: 1px solid var(--border-soft); border-left: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; z-index: 1000;
      font-size: 18px; color: var(--text-main);
    }

    .layout.sidebar-collapsed #sidebarToggle {
      left: 0; border-radius: 999px 0 0 999px;
    }

    /* TOPBAR */
    #topbar {
      height: 48px;
      background: var(--bg-topbar);
      border-bottom: 1px solid var(--border-soft);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 12px;
      z-index: 10;
    }

    #map-container {
      position: relative;
      flex: 1;
      height: calc(100vh - 48px);
      min-height: 350px;
    }

    #map {
      position: absolute;
      inset: 0;
      width: 100%; height: 100%;
      z-index: 1;
    }

    /* POPUP */
    .popup-card {
      width: 260px;
      padding: 12px 14px 10px;
      border-radius: 18px;
      background: linear-gradient(145deg,#0f172a,#020617);
      color: #e5e7eb;
      font-size: 13px;
    }
  </style>
</head>
<body data-theme="dark">

<div class="layout" id="layout">
  
  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div>
      <div class="brand">Tr·∫°m c·∫£m bi·∫øn b√°o ng·∫≠p</div>
      <div class="subtitle">Realtime ‚Ä¢ Firebase ‚Ä¢ ESP32</div>
    </div>

    <input id="searchBox" class="search-box" placeholder="T√¨m tr·∫°m..."/>

    <div class="sidebar-section-title">Danh s√°ch tr·∫°m</div>
    <div id="stationList" class="station-list"></div>

    <div class="sidebar-footer">Thu nh·ªè sidebar ƒë·ªÉ xem b·∫£n ƒë·ªì r·ªông h∆°n.</div>
  </aside>

  <div id="sidebarToggle">‚Æú</div>

  <!-- MAIN -->
  <main id="main">

    <div id="topbar">
      <div>
        <button class="tab-btn active" id="tabMap">B·∫£n ƒë·ªì realtime</button>
        <button class="tab-btn" id="tabHistory">L·ªãch s·ª≠ & b√°o c√°o</button>
      </div>

      <div>
        <button class="pill-btn" id="btnHeatmap">üåà Heatmap: OFF</button>
        <button class="pill-btn" id="btnTheme">üåô Dark</button>
      </div>
    </div>

    <div id="map-container">
      <div id="map"></div>

      <div id="historyPanel">
        <h3>L·ªãch s·ª≠ m·ª±c n∆∞·ªõc</h3>

        <div class="panel-row">
          <select id="historyStation"></select>
          <input type="date" id="historyDate"/>
        </div>

        <div class="panel-row">
          <button class="small-btn" id="btnLoadHistory">T·∫£i ng√†y</button>
          <button class="small-btn" id="btnToday">H√¥m nay</button>
          <button class="small-btn" id="btn7d">7 ng√†y</button>
          <button class="small-btn" id="btn30d">30 ng√†y</button>
        </div>

        <canvas id="historyChart" height="220"></canvas>

        <div class="panel-footer">
          <button class="small-btn" id="btnCsv">Xu·∫•t CSV</button>
          <button class="small-btn" id="btnPdf">Xu·∫•t PDF</button>
        </div>
      </div>

    </div>
  </main>
</div>
<!-- LIBS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- MAIN SCRIPT ‚Äì ONLY ONE -->
<script type="module">

/* ============================
     IMPORT FIREBASE
============================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, get, child }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ============================
     THEME SWITCH
============================= */
const body = document.body;
const btnTheme = document.getElementById("btnTheme");
body.dataset.theme = localStorage.getItem("ngap-theme") || "dark";

btnTheme.onclick = () => {
  body.dataset.theme = body.dataset.theme === "dark" ? "light" : "dark";
  localStorage.setItem("ngap-theme", body.dataset.theme);
  btnTheme.textContent = body.dataset.theme === "light" ? "‚òÄÔ∏è Light" : "üåô Dark";
};
btnTheme.textContent = body.dataset.theme === "light" ? "‚òÄÔ∏è Light" : "üåô Dark";

/* ============================
     FIREBASE CONFIG
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyC2aoNSms-fOf0jjAeIwxmE-X1RfPlvEL4",
  authDomain: "tram-do-1.firebaseapp.com",
  databaseURL: "https://tram-do-1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tram-do-1",
  storageBucket: "tram-do-1.appspot.com",
  messagingSenderId: "1053488938946",
  appId: "1:1053488938946:web:7f9f4dbc1aca8dffb7605b"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ============================
     MAP INIT
============================= */
const map = L.map("map", { zoomControl: true })
  .setView([10.77563018246902, 106.65557870049943], 16);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

setTimeout(() => map.invalidateSize(true), 700);
window.addEventListener("resize", () => map.invalidateSize(true));

/* ============================
     HEATMAP
============================= */
let heatmapEnabled = false;
const heatLayer = L.heatLayer([], { radius: 35, blur: 20 }).addTo(map);

function updateHeatmap(sts) {
  if (!heatmapEnabled) return heatLayer.setLatLngs([]);
  const pts = Object.entries(sts).map(([id,s]) => [
    s.lat, s.lng, Math.min((s.water_level||0)/50,1)
  ]);
  heatLayer.setLatLngs(pts);
}

document.getElementById("btnHeatmap").onclick = () => {
  heatmapEnabled = !heatmapEnabled;
  document.getElementById("btnHeatmap").textContent =
    heatmapEnabled ? "üåà Heatmap: ON" : "üåà Heatmap: OFF";
  updateHeatmap(currentStations);
};

/* ============================
     STATIONS REALTIME
============================= */
const stationsRef = ref(db, "stations");
let currentStations = {};
const markers = {};
let openedPopup = null;

function createMarker(id, s) {
  const status = s.water_level < 5 ? "green" :
                 s.water_level < 15 ? "blue" :
                 s.water_level < 30 ? "orange" : "red";

  const icon = L.icon({
    iconUrl:
      `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${status}.png`,
    iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34]
  });

  if (!markers[id]) {
    markers[id] = L.marker([s.lat, s.lng], { icon }).addTo(map);
    markers[id].on("click", () => showPopup(id));
  } else {
    markers[id].setLatLng([s.lat, s.lng]);
    markers[id].setIcon(icon);
  }
}

function showPopup(id) {
  const s = currentStations[id];
  if (!s) return;
  openedPopup = id;

  const html = `
    <div class="popup-card">
      <div class="popup-title">${s.name}</div>
      <div class="popup-sub">${s.address}</div>
      <div class="popup-chip">${s.water_level} cm</div>
      <div class="popup-row">üåä M·ª±c n∆∞·ªõc <b>${s.water_level} cm</b></div>
      <div class="popup-row">üöß Ng·∫≠p m·∫∑t ƒë∆∞·ªùng <b>${s.road_flood} cm</b></div>
    </div>
  `;

  markers[id].bindPopup(html).openPopup();
}

function buildSidebar(sts) {
  const box = document.getElementById("stationList");
  box.innerHTML = "";
  const sel = document.getElementById("historyStation");
  sel.innerHTML = "";

  Object.entries(sts).forEach(([id,s]) => {
    const div = document.createElement("div");
    div.className = "station-item";
    div.dataset.id = id;
    div.innerHTML = `
      <div class="station-name">${s.name}</div>
      <div class="chip">M·ª±c n∆∞·ªõc: ${s.water_level} cm</div>
    `;
    div.onclick = () => {
      map.setView([s.lat, s.lng], 17);
      showPopup(id);
    };
    box.appendChild(div);

    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

onValue(stationsRef, snap => {
  const data = snap.val() || {};
  currentStations = data;

  Object.entries(data).forEach(([id,s]) => createMarker(id,s));
  buildSidebar(data);
  updateHeatmap(data);

  if (openedPopup && currentStations[openedPopup]) showPopup(openedPopup);

  map.invalidateSize();
});

/* ============================
     SEARCH
============================= */
document.getElementById("searchBox").oninput = () => {
  const q = searchBox.value.toLowerCase();
  document.querySelectorAll(".station-item").forEach(e => {
    const name = e.innerText.toLowerCase();
    e.style.display = name.includes(q) ? "" : "none";
  });
};

/* ============================
     TABS
============================= */
document.getElementById("tabMap").onclick = () => {
  document.getElementById("historyPanel").style.display = "none";
  document.getElementById("tabMap").classList.add("active");
  document.getElementById("tabHistory").classList.remove("active");
  map.invalidateSize();
};

document.getElementById("tabHistory").onclick = () => {
  document.getElementById("historyPanel").style.display = "block";
  document.getElementById("tabHistory").classList.add("active");
  document.getElementById("tabMap").classList.remove("active");
  setTimeout(() => map.invalidateSize(), 300);
};

/* ============================
     FIX MAP FULL
============================= */
setTimeout(() => map.invalidateSize(true), 800);
window.addEventListener("load", () => map.invalidateSize(true));

</script>

</body>
</html>
