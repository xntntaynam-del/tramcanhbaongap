<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gi√°m s√°t ng·∫≠p ‚Äì IoT Flood System</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0ea5e9" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />

  <!-- ============================
       CSS GIAO DI·ªÜN
  ============================ -->
  <style>

/* SIDEBAR COLLAPSE */
#sidebarCollapseBtn {
  position: absolute;
  top: 50px;
  right: -10px;
  width: 32px;
  height: 32px;
  background: #ffffff;
  border: 5px solid #d1d5db;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  z-index: 1000;
  transition: transform 0.25s ease;
}

#sidebar.collapsed {
  width: 48px !important;
  overflow: hidden;
}

#sidebar.collapsed * {
  opacity: 0;
  pointer-events: none;
}

#sidebar.collapsed #sidebarCollapseBtn {
  opacity: 1;
  pointer-events: auto;
  transform: rotate(180deg);
}

#map.sidebar-collapsed {
  left: 48px !important;
}


@keyframes pulseBlink {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.25); opacity: 0.6; }
  100% { transform: scale(1); opacity: 1; }
}

    #sidebarTitle {
      font-size: 17px;
      font-weight: 700;
      color: #0ea5e9;
      line-height: 20px;
      margin-bottom: 4px;
    }

    #sidebarSubtitle {
      font-size: 13px;
      color: #0ea5e9;
      margin-bottom: 12px;
    }

    #stationSearch {
      width: 100%;
      padding: 10px 14px;
      border-radius: 20px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 13px;
      margin-bottom: 14px;
      box-sizing: border-box;
    }
    #stationSearch:focus {
      border-color: #0ea5e9;
    }

    /* ·∫®n realtime panel (gi·ªØ code JS nh∆∞ng kh√¥ng hi·ªÉn th·ªã) */
    #realtimePanel {
      display: none !important;
    }

    :root {
      --bg: #f5f6fa;
      --bg-card: #ffffff;
      --border-soft: #e5e7eb;
      --text-main: #1f2937;
      --text-sub: #6b7280;

      --safe: #4ade80;
      --light: #3b82f6;
      --medium: #f97316;
      --heavy: #ef4444;
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      color: var(--text-main);
    }

    /* Sidebar */
    #sidebar {
      width: 330px;
      height: 100vh;
      overflow-y: auto;
      background: #ffffff;
      border-right: 1px solid var(--border-soft);
      position: fixed;
      top: 0;
      left: 0;
      padding: 14px;
      box-sizing: border-box;
      z-index: 999;
    }

    .sidebar-section-title {
      font-size: 13px;
      font-weight: 600;
      margin: 12px 0 8px;
      color: #374151;
    }

    .station-item {
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .station-item:hover {
      background: #f0f9ff;
    }

    .station-name {
      font-size: 14px;
      font-weight: 600;
    }
    .station-id {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    .chip {
      display: flex;
      gap: 4px;
      font-size: 13px;
    }

    .status-icon {
      margin-right: 4px;
    }

    .status-safe   { color: var(--safe); }
    .status-light  { color: var(--light); }
    .status-medium { color: var(--medium); }
    .status-heavy  { color: var(--heavy); }

    /* Dashboard nh·ªè trong sidebar */
    .sidebar-dashboard {
      margin-top: 8px;
      margin-bottom: 12px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }
    .sidebar-dashboard-card {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      padding: 8px;
      border-radius: 10px;
    }
    .sidebar-dashboard-label {
      color: var(--text-sub);
      font-size: 11px;
    }
    .sidebar-dashboard-value {
      font-weight: 600;
      font-size: 15px;
    }

    /* MAP: ch·ª´a 260px ph√≠a d∆∞·ªõi cho panel L·ªãch s·ª≠ */
    #map {
      position: fixed;
      top: 0;
      left: 330px;
      right: 0;
      bottom: 260px;
      background: #eef2f7;
      z-index: 1;
    }

    /* N√∫t Heatmap */
    #heatToggle {
      position: fixed;
      top: 10px;
      right: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      font-size: 12px;
      cursor: pointer;
      z-index: 900;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #heatToggle.on {
      background: #0ea5e9;
      color: #ffffff;
      border-color: #0ea5e9;
    }

    /* Popup card */
    .popup-card {
      width: 250px;
      background: #ffffff;
      border-radius: 12px;
      padding: 14px;
      font-size: 13px;
      color: #111827;
    }
    .popup-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 2px;
    }
    .popup-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .water-main {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 10px;
      color: white;
      text-align: center;
    }
    .water-main.safe   { background: var(--safe); }
    .water-main.light  { background: var(--light); }
    .water-main.medium { background: var(--medium); }
    .water-main.heavy  { background: var(--heavy); }

    .pulse-alert {
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .popup-row {
      margin-bottom: 6px;
    }

    .popup-link {
      display: block;
      margin-top: 8px;
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }

    /* Marker gradient (div icon) */
    .dyn-marker-outer {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 0 6px rgba(148, 163, 184, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .dyn-marker-inner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
    }

    /* PANEL L·ªäCH S·ª¨ & B√ÅO C√ÅO */
    #historyPanel {
      position: fixed;
      bottom: 0;
      left: 330px;
      right: 0;
      height:260px;
      background: #f9fafb;
      border-top: 1px solid var(--border-soft);
      padding: 8px 14px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      z-index: 500;
      overflow-y: auto;
    }

    /* MOBILE */
    @media (max-width: 768px) {
      #sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      #map {
        top: 0;
        left: 0;
        right: 0;
        bottom: 260px;
        position: fixed;
      }
      #historyPanel {
        left: 0;
        right: 0;
      }
      #heatToggle {
        right: 8px;
      }
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "FAKE",
      authDomain: "tram-do-1.firebaseapp.com",
      databaseURL: "https://tram-do-1-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tram-do-1",
    };
    firebase.initializeApp(firebaseConfig);
  </script>
<script>
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const mapEl = document.getElementById("map");

  sidebar.classList.toggle("collapsed");
  mapEl.classList.toggle("sidebar-collapsed");

  setTimeout(() => {
    map.invalidateSize();
  }, 300);
}
</script>

</head>
<body>
  <!-- ============================
       SIDEBAR + DASHBOARD
  ============================ -->
  <div id="sidebar">
<div id="sidebarCollapseBtn" onclick="toggleSidebar()">
‚û§
</div>

    <div id="sidebarTitle">
      C√îNG TY TNHH MTV THO√ÅT N∆Ø·ªöC<br />ƒê√î TH·ªä TP.H·ªí CH√ç MINH
    </div>
    <div id="sidebarSubtitle">Tr·∫°m c·∫£m bi·∫øn b√°o ng·∫≠p v√† tri·ªÅu</div>

    <input
      type="text"
      id="stationSearch"
      placeholder="T√¨m tr·∫°m theo t√™n ho·∫∑c ID..."
      oninput="searchStation(this.value)"
    />

    <div class="sidebar-section-title">T·ªïng quan h·ªá th·ªëng</div>

    <div class="sidebar-dashboard">
      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">T·ªïng tr·∫°m</div>
        <div class="sidebar-dashboard-value" id="dbTotalStations">0</div>
      </div>

      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">Kh√¥ng ng·∫≠p</div>
        <div class="sidebar-dashboard-value" id="dbLevel0">0</div>
      </div>

      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">Ng·∫≠p nh·∫π</div>
        <div class="sidebar-dashboard-value" id="dbLevel1">0</div>
      </div>

      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">Ng·∫≠p v·ª´a</div>
        <div class="sidebar-dashboard-value" id="dbLevel2">0</div>
      </div>

      <div class="sidebar-dashboard-card">
        <div class="sidebar-dashboard-label">Ng·∫≠p n·∫∑ng</div>
        <div class="sidebar-dashboard-value" id="dbLevel3">0</div>
      </div>
    </div>

    <div class="sidebar-section-title">Danh s√°ch tr·∫°m</div>
    <div id="stationList"></div>
  </div>

  <!-- ============================
       MAP + N√öT HEATMAP
  ============================ -->
  <div id="map"></div>
  <div id="heatToggle" onclick="toggleHeatmap()">
    <span>Heatmap:</span><strong>OFF</strong>
  </div>

  <!-- ============================
       REALTIME PANEL (ƒêANG B·ªä ·∫®N B·∫∞NG CSS)
  ============================ -->
  <div id="realtimePanel" class="rt-safe">
    <div style="font-size: 14px; font-weight: 600">
      Tr·∫°ng th√°i: <span id="realtimeStatusBadge">Kh√¥ng ng·∫≠p</span>
    </div>

    <canvas id="realtimeChart" height="80" style="margin-top: 6px"></canvas>
  </div>

  <!-- ============================
       L·ªäCH S·ª¨ & B√ÅO C√ÅO
  ============================ -->
  <div id="historyPanel">
    <div style="display:flex; align-items:center; gap:8px;">
      <div style="font-weight:600;">L·ªãch s·ª≠ &amp; b√°o c√°o</div>

      <select id="historyStationSelect"
              style="padding:3px 6px; border-radius:6px; border:1px solid #d1d5db; font-size:12px;"></select>

      <input type="date"
             id="historyDate"
             style="padding:3px 6px; border-radius:6px; border:1px solid #d1d5db; font-size:12px;" />

      <button onclick="loadHistory()"
              style="padding:4px 10px; border-radius:6px; border:none; background:#2563eb; color:#fff; font-size:12px; cursor:pointer;">
        Xem l·ªãch s·ª≠
      </button>

      <button onclick="exportHistoryCSV()"
              style="padding:4px 10px; border-radius:6px; border:1px solid #9ca3af; background:#fff; font-size:12px; cursor:pointer;">
        ‚¨á CSV
      </button>

      <button onclick="exportHistoryPDF()"
              style="padding:4px 10px; border-radius:6px; border:1px solid #e11d48; background:#fff5f5; color:#b91c1c; font-size:12px; cursor:pointer;">
        üìÑ PDF
      </button>

      <span id="historyInfo"
            style="margin-left:auto; font-size:12px; color:#6b7280;"></span>
    </div>

    <canvas id="historyChart" height="120"></canvas>

    <!-- CARD TH·ªêNG K√ä (KI·ªÇU B) -->
    <div id="historyStatsCard"
         style="
            background:#ffffff;
            border:1px solid #e5e7eb;
            box-shadow:0 1px 3px rgba(0,0,0,0.06);
            padding:14px;
            border-radius:12px;
            margin-top:10px;
            font-size:13px;
            display:none;
         ">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:700; font-size:15px;">
          üìå Th·ªëng k√™ ng·∫≠p trong ng√†y
        </div>
      </div>

      <!-- NHI·ªÄU ƒê·ª¢T M∆ØA/NG·∫¨P S·∫º HI·ªÇN TH·ªä T·∫†I ƒê√ÇY -->
      <div id="multiEventContainer"></div>

      <div style="margin-top:12px; font-weight:700; font-size:14px;">
        üìä Th·ªëng k√™ b·ªï sung
      </div>

      <div id="statAvgDepth" style="margin-top:6px;"></div>
      <div id="statFloodDuration" style="margin-top:6px;"></div>
    </div>
  </div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <!-- Leaflet Heatmap plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF ƒë·ªÉ xu·∫•t PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /* ============================================
       BI·∫æN TO√ÄN C·ª§C
    ============================================ */
    let map;
    let markers = {};
    let currentStations = {};
    let activeStationId = null;

    // Heatmap
    let heatLayer = null;
    let heatEnabled = false;

    let realtimeChart = null;
    let realtimeSeries = {};
    const REALTIME_MAX_POINTS = 60;

    let historyChartInstance = null;
    let historyLastRows = [];
    let historyLastStats = null;
    let historyLastPeriods = [];

    /* ==========================
       KH·ªûI T·∫†O MAP ‚Äì ZOOM TP.HCM
    ========================== */
    function initMap() {
      map = L.map("map").setView([10.7756, 106.7009], 12);

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);
    }

    /* ============================================
       H√ÄM SINH M√ÄU / NH√ÉN M·ª®C NG·∫¨P THEO flood_level
    ============================================ */
    function makeStatus(level) {
      level = Number(level ?? 0);

      if (level === 0)
        return { label: "Kh√¥ng ng·∫≠p", className: "status-safe" };

      if (level === 1)
        return { label: "Ng·∫≠p nh·∫π", className: "status-light" };

      if (level === 2)
        return { label: "Ng·∫≠p v·ª´a", className: "status-medium" };

      if (level >= 3)
        return { label: "Ng·∫≠p n·∫∑ng", className: "status-heavy" };

      return { label: "Kh√¥ng x√°c ƒë·ªãnh", className: "status-safe" };
    }

    /* ============================================
       MARKER GRADIENT THEO M·ª∞C N∆Ø·ªöC
    ============================================ */
    function createOrUpdateMarker(id, s) {
      if (!s || !s.lat || !s.lng) return;

      const water = Number(s.water_level ?? 0);

      // map 0‚Äì30 cm ‚Üí hue 120 (xanh) ‚Üí 0 (ƒë·ªè)
      const ratio = Math.max(0, Math.min(1, water / 30));
      const hue = 120 - 120 * ratio;
      const color = `hsl(${hue}, 90%, 50%)`;

      const html = `
        <div class="dyn-marker-outer">
          <div class="dyn-marker-inner" style="background:${color};"></div>
        </div>
      `;

      const icon = L.divIcon({
        className: "dyn-marker",
        html,
        iconSize: [24, 24],
        iconAnchor: [12, 24],
      });

      const latlng = [s.lat, s.lng];

      if (!markers[id]) {
        markers[id] = L.marker(latlng, { icon }).addTo(map);
        markers[id].on("click", () => showStationPopup(id));
      } else {
        markers[id].setLatLng(latlng);
        markers[id].setIcon(icon);
      }
    }

    /* ============================================
       HI·ªÇN TH·ªä POPUP THEO flood_level
    ============================================ */
    function showStationPopup(id) {
      const s = currentStations[id];
      if (!s) return;

      activeStationId = id;

      const meta = {
        name: s.name || `Tr·∫°m ${id}`,
        address: s.address || "",
        lat: s.lat,
        lng: s.lng,
      };

      const water = s.water_level ?? 0;
      const road = s.road_flood ?? water;
      const rise = s.rise_rate ?? 0;
      const fall = s.fall_rate ?? 0;
      const dur = s.flood_duration ?? 0;
      const over = Number(s.over_sidewalk) === 1;
      const level = Number(s.flood_level ?? 0);

      const area = 0; // t∆∞∆°ng lai c√≥ th·ªÉ t√≠nh S t·ª± ƒë·ªông

      const st = makeStatus(level);

      let wmClass = "safe";
      if (level === 1) wmClass = "light";
      else if (level === 2) wmClass = "medium";
      else if (level >= 3) wmClass = "heavy";

      const waterIcon =
        level === 0 ? "üíß" :
        level === 1 ? "üí¶" :
        level === 2 ? "üåä" :
        "üö®";

      const html = `
        <div class="popup-card">
          <div class="popup-title">${meta.name}</div>
          <div class="popup-sub">${meta.address}</div>

          <div class="water-main ${wmClass} ${level >= 3 ? "pulse-alert" : ""}">
            <div class="water-value">${water.toFixed(1)} cm</div>
            <div class="water-label">${waterIcon} ${st.label}</div>
          </div>

          <div class="popup-row">üöß Ng·∫≠p m·∫∑t ƒë∆∞·ªùng: <b>${road.toFixed(1)} cm</b></div>
          <div class="popup-row">
            üü• Tr√†n l·ªÅ:
            <b style="color:${over ? "#ef4444" : "#4ade80"};">
              ${over ? "C√≥" : "Kh√¥ng"}
            </b>
          </div>
          <div class="popup-row">üìà D√¢ng: <b>${rise.toFixed(2)} cm/ph√∫t</b></div>
          <div class="popup-row">üìâ R√∫t: <b>${fall.toFixed(2)} cm/ph√∫t</b></div>
          <div class="popup-row">‚è± Th·ªùi gian ng·∫≠p: <b>${dur.toFixed(1)} ph√∫t</b></div>
          

          <a class="popup-link"
            target="_blank"
            href="https://maps.google.com/?q=${meta.lat},${meta.lng}">
            üìç Xem tr√™n Google Maps
          </a>
        </div>
      `;

      markers[id].unbindPopup();
      markers[id].bindPopup(html).openPopup();
    }

    /* ============================================
       C·∫¨P NH·∫¨T MARKER T·ª™ DANH S√ÅCH TR·∫†M + HEATMAP
    ============================================ */
    function updateMarkers(data) {
      Object.entries(data).forEach(([id, s]) => {
        createOrUpdateMarker(id, s);
      });
      updateHeatmapLayer();
    }

    /* ============================================
       BUILD DATA & C·∫¨P NH·∫¨T HEATMAP
    ============================================ */
    function buildHeatData() {
      const points = [];
      Object.values(currentStations).forEach((s) => {
        if (!s || !s.lat || !s.lng) return;
        const wl = Number(s.water_level ?? 0);
        if (wl <= 0) return;
        const intensity = Math.max(0.1, Math.min(1, wl / 30)); // 0‚Äì30cm
        points.push([s.lat, s.lng, intensity]);
      });
      return points;
    }

    function updateHeatmapLayer() {
      if (!map) return;

      const data = buildHeatData();

      if (!heatEnabled) {
        if (heatLayer) {
          map.removeLayer(heatLayer);
          heatLayer = null;
        }
        return;
      }

      if (!heatLayer) {
        heatLayer = L.heatLayer(data, {
          radius: 30,
          blur: 25,
          maxZoom: 18,
        }).addTo(map);
      } else {
        heatLayer.setLatLngs(data);
      }
    }

    function toggleHeatmap() {
      heatEnabled = !heatEnabled;
      const btn = document.getElementById("heatToggle");
      if (heatEnabled) {
        btn.classList.add("on");
        btn.querySelector("strong").textContent = "ON";
      } else {
        btn.classList.remove("on");
        btn.querySelector("strong").textContent = "OFF";
      }
      updateHeatmapLayer();
    }

    /* ============================================
       SIDEBAR: DANH S√ÅCH TR·∫†M + DASHBOARD + SELECT L·ªäCH S·ª¨
    ============================================ */
    function buildSidebar(stationsMap) {
      const list = document.getElementById("stationList");
      list.innerHTML = "";

      const historySelect = document.getElementById("historyStationSelect");
      if (historySelect) historySelect.innerHTML = "";

      let total = 0;
      let c0 = 0, c1 = 0, c2 = 0, c3 = 0;

      Object.entries(stationsMap).forEach(([id, s]) => {
        total++;

        const level = Number(s.flood_level ?? 0);
        if (level === 0) c0++;
        else if (level === 1) c1++;
        else if (level === 2) c2++;
        else if (level === 3) c3++;

        const st = makeStatus(level);
        const metaName = s.name || id;

        const waterIcon =
          level === 0 ? "üíß" :
          level === 1 ? "üí¶" :
          level === 2 ? "üåä" :
          "üö®";

        const water = s.water_level ?? 0;

        const div = document.createElement("div");
        div.className = "station-item";
        div.onclick = () => showStationPopup(id);

        div.innerHTML = `
          <div class="station-name">${metaName}</div>
          <div class="station-id">${id}</div>

          <div class="chip">
            <span class="${st.className}">
              <span class="status-icon">${waterIcon}</span>
              ${water.toFixed ? water.toFixed(1) : water} cm ‚Äî ${st.label}
            </span>
          </div>
        `;

        list.appendChild(div);

        if (historySelect) {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = `${metaName} (${id})`;
          historySelect.appendChild(opt);
        }
      });

      document.getElementById("dbTotalStations").textContent = total;
      document.getElementById("dbLevel0").textContent = c0;
      document.getElementById("dbLevel1").textContent = c1;
      document.getElementById("dbLevel2").textContent = c2;
      document.getElementById("dbLevel3").textContent = c3;
    }
    /* ============================================
       FETCH D·ªÆ LI·ªÜU TR·∫†M T·ª™ FIREBASE
    ============================================ */
    function fetchStations() {
      firebase
        .database()
        .ref("stations")
        .on("value", (snap) => {
          const data = snap.val() || {};
          currentStations = data;

          buildSidebar(data);
          updateMarkers(data);
        });
    }

    /* ============================================
       REALTIME ‚Äî ƒêANG ·∫®N UI NH∆ØNG V·∫™N C√ì TH·ªÇ D√ôNG
    ============================================ */
    function updateRealtimePanelStatus(levelRaw) {
      const panel = document.getElementById("realtimePanel");
      const badge = document.getElementById("realtimeStatusBadge");

      if (!panel || !badge) return;

      const st = makeStatus(levelRaw);
      badge.textContent = st.label;

      panel.classList.remove(
        "rt-safe",
        "rt-warning",
        "rt-danger",
        "pulse-strong"
      );

      const lvl = Number(levelRaw ?? 0);

      if (lvl === 0) {
        panel.classList.add("rt-safe");
      } else if (lvl === 1) {
        panel.classList.add("rt-warning");
      } else if (lvl === 2) {
        panel.classList.add("rt-danger");
      } else if (lvl >= 3) {
        panel.classList.add("rt-danger", "pulse-strong");
      }
    }

    function drawRealtimeChart(labels, values) {
      if (!realtimeChart) {
        const ctx = document.getElementById("realtimeChart").getContext("2d");

        realtimeChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "M·ª±c n∆∞·ªõc (cm)",
                data: values,
                borderColor: "#2563eb",
                backgroundColor: "rgba(37,99,235,0.3)",
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0,
              },
            ],
          },
          options: {
            animation: false,
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      } else {
        realtimeChart.data.labels = labels;
        realtimeChart.data.datasets[0].data = values;
        realtimeChart.update();
      }
    }

    function updateRealtimeForStation(id, s) {
      const wl = s.water_level ?? 0;
      const now = new Date();
      const timeLabel = now.toTimeString().slice(3, 8);

      if (!realtimeSeries[id]) {
        realtimeSeries[id] = { labels: [], values: [] };
      }

      const series = realtimeSeries[id];

      series.labels.push(timeLabel);
      series.values.push(wl);

      if (series.labels.length > REALTIME_MAX_POINTS) {
        series.labels.shift();
        series.values.shift();
      }

      if (id === activeStationId) {
        drawRealtimeChart(series.labels, series.values);
        updateRealtimePanelStatus(s.flood_level ?? 0);
      }
    }

    function startRealtimeListener() {
      firebase
        .database()
        .ref("stations")
        .on("value", (snap) => {
          const data = snap.val() || {};

          Object.entries(data).forEach(([id, s]) => {
            updateRealtimeForStation(id, s);
          });

          // c·∫≠p nh·∫≠t heatmap khi water_level thay ƒë·ªïi realtime
          currentStations = data;
          updateHeatmapLayer();
        });
    }

    /* ============================================
       T√åM KI·∫æM TR·∫†M
    ============================================ */
    function searchStation(keyword) {
      keyword = keyword.toLowerCase();
      const list = document.getElementById("stationList");
      list.innerHTML = "";

      Object.entries(currentStations).forEach(([id, s]) => {
        const name = (s.name || "").toLowerCase();

        if (name.includes(keyword) || id.toLowerCase().includes(keyword)) {
          const level = Number(s.flood_level ?? 0);
          const st = makeStatus(level);
          const water = s.water_level ?? 0;

          const waterIcon =
            level === 0 ? "üíß" :
            level === 1 ? "üí¶" :
            level === 2 ? "üåä" :
            "üö®";

          const div = document.createElement("div");
          div.className = "station-item";
          div.onclick = () => showStationPopup(id);

          div.innerHTML = `
            <div class="station-name">${s.name || id}</div>
            <div class="station-id">${id}</div>
            <div class="chip">
              <span class="${st.className}">
                <span class="status-icon">${waterIcon}</span>
                ${water.toFixed(1)} cm ‚Äì ${st.label}
              </span>
            </div>
          `;
          list.appendChild(div);
        }
      });
    }

    /* =====================================================
       T·∫¢I EVENTS TRONG NG√ÄY T·ª™ FIREBASE
       events/{stationId}/{date}/start_rain/{ts}
       ‚Üí H·ªó tr·ª£ nhi·ªÅu ƒë·ª£t m∆∞a/ng·∫≠p
    ===================================================== */
    function loadDailyEvents(stationId, date) {
      return firebase.database()
        .ref(`events/${stationId}/${date}`)
        .once("value")
        .then(snap => snap.val() || {});
    }

    function formatTS(ts) {
      if (!ts) return "‚Äî";
      const d = new Date(ts * 1000);
      return d.toTimeString().slice(0, 5);
    }

    /* =====================================================
       PH√ÇN T√çCH NHI·ªÄU ƒê·ª¢T M∆ØA/NG·∫¨P
    ===================================================== */
    function buildMultiEventList(events) {
      const periods = [];

      if (!events) return periods;

      const rainStarts  = events.start_rain  ? Object.values(events.start_rain)  : [];
      const rainEnds    = events.end_rain    ? Object.values(events.end_rain)    : [];
      const floodStarts = events.start_flood ? Object.values(events.start_flood) : [];
      const floodEnds   = events.end_flood   ? Object.values(events.end_flood)   : [];

      rainStarts.sort((a,b)=>a.timestamp - b.timestamp);
      rainEnds.sort((a,b)=>a.timestamp - b.timestamp);
      floodStarts.sort((a,b)=>a.timestamp - b.timestamp);
      floodEnds.sort((a,b)=>a.timestamp - b.timestamp);

      const maxLen = Math.max(
        rainStarts.length,
        floodStarts.length,
        rainEnds.length,
        floodEnds.length
      );

      for (let i = 0; i < maxLen; i++) {
        periods.push({
          rainStart:  rainStarts[i]?.timestamp || null,
          floodStart: floodStarts[i]?.timestamp || null,
          rainEnd:    rainEnds[i]?.timestamp || null,
          floodEnd:   floodEnds[i]?.timestamp || null
        });
      }

      return periods;
    }

    /* =====================================================
       T√çNH TO√ÅN TH·ªêNG K√ä:
       - ƒê·ªô s√¢u trung b√¨nh
       - T·ªïng th·ªùi gian ng·∫≠p li√™n t·ª•c (ph√∫t)
    ===================================================== */
    function computeHistoryStats(historyData) {
      const entries = Object.entries(historyData)
        .sort((a, b) => a[0].localeCompare(b[0]));

      let totalDepth = 0;
      let count = 0;
      let floodMinutes = 0;

      entries.forEach(([time, v]) => {
        const wl = v.water_level ?? 0;

        totalDepth += wl;
        count++;

        if (wl > 0) floodMinutes++;
      });

      return {
        avgDepth: count > 0 ? totalDepth / count : 0,
        floodDuration: floodMinutes
      };
    }

    /* =====================================================
       HI·ªÇN TH·ªä ƒêA ƒê·ª¢T M∆ØA / NG·∫¨P TRONG CARD KI·ªÇU B
    ===================================================== */
    function renderMultiEventCard(periods) {
      const box = document.getElementById("multiEventContainer");
      const card = document.getElementById("historyStatsCard");

      if (!box || !card) return;

      box.innerHTML = "";

      if (!periods || periods.length === 0) {
        box.innerHTML = "<div>Kh√¥ng c√≥ ƒë·ª£t m∆∞a/ng·∫≠p trong ng√†y.</div>";
        card.style.display = "block";
        return;
      }

      let html = "";

      periods.forEach((p, i) => {
        html += `
          <div style="margin-top:6px; padding:6px 0; border-bottom:1px solid #eee;">
            <div style="font-weight:600; margin-bottom:4px;">
              üü¶ ƒê·ª£t ${i + 1}
            </div>
            <div>üåß B·∫Øt ƒë·∫ßu m∆∞a: <b>${formatTS(p.rainStart)}</b></div>
            <div>üíß B·∫Øt ƒë·∫ßu ng·∫≠p: <b>${formatTS(p.floodStart)}</b></div>
            <div>‚õÖ H·∫øt m∆∞a: <b>${formatTS(p.rainEnd)}</b></div>
            <div>üèÅ H·∫øt ng·∫≠p: <b>${formatTS(p.floodEnd)}</b></div>
          </div>
        `;
      });

      box.innerHTML = html;
      card.style.display = "block";
    }

    /* =====================================================
       C·∫¨P NH·∫¨T 2 CH·ªà S·ªê B·ªî SUNG TRONG CARD
    ===================================================== */
    function updateAdditionalStats(stats) {
      document.getElementById("statAvgDepth").textContent =
        `üìè ƒê·ªô s√¢u trung b√¨nh: ${stats.avgDepth.toFixed(1)} cm`;

      document.getElementById("statFloodDuration").textContent =
        `‚è± Th·ªùi gian ng·∫≠p li√™n t·ª•c: ${stats.floodDuration} ph√∫t`;
    }

    /* ============================================
       L·ªäCH S·ª¨ & B√ÅO C√ÅO THEO NG√ÄY ‚Äì V·∫º CHART
    ============================================ */
    function drawHistoryChart(labels, values) {
      const ctx = document.getElementById("historyChart").getContext("2d");

      if (!historyChartInstance) {
        historyChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "M·ª±c n∆∞·ªõc (cm)",
                data: values,
                borderColor: "#2563eb",
                backgroundColor: "rgba(37, 99, 235, 0.15)",
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            animation: false,
            plugins: {
              legend: { display: true },
              title: { display: false },
            },
            scales: {
              y: { beginAtZero: true },
            },
          },
        });
      } else {
        historyChartInstance.data.labels = labels;
        historyChartInstance.data.datasets[0].data = values;
        historyChartInstance.update();
      }
    }
    /* =====================================================
       LOAD HISTORY + EVENTS + MULTI PERIOD RENDERING
    ===================================================== */
    function loadHistory() {
      const stationSelect = document.getElementById("historyStationSelect");
      const dateInput = document.getElementById("historyDate");
      const info = document.getElementById("historyInfo");

      if (!stationSelect || !dateInput) return;

      const stationId = stationSelect.value;
      const date = dateInput.value;

      if (!stationId || !date) {
        if (info) info.textContent = "Ch·ªçn tr·∫°m v√† ng√†y.";
        return;
      }

      if (info) info.textContent = "ƒêang t·∫£i d·ªØ li·ªáu ...";

      const historyRef = firebase.database().ref(`history/${stationId}/${date}`);

      Promise.all([
        historyRef.once("value"),
        loadDailyEvents(stationId, date)
      ])
      .then(([historySnap, events]) => {
        const historyData = historySnap.val() || {};
        const entries = Object.entries(historyData)
          .sort((a, b) => a[0].localeCompare(b[0]));

        const labels = [];
        const values = [];
        historyLastRows = [];

        entries.forEach(([time, v]) => {
          const wl = v.water_level ?? 0;
          labels.push(time);
          values.push(wl);

          historyLastRows.push([
            `${date} ${time}`,
            wl,
            v.road_flood ?? "",
            v.rise_rate ?? "",
            v.fall_rate ?? "",
            v.over_sidewalk ?? "",
            v.flood_duration ?? "",
          ]);
        });

        drawHistoryChart(labels, values);
        if (info) info.textContent = `T·ªïng ${entries.length} b·∫£n ghi`;

        // ph√¢n t√≠ch ƒëa ƒë·ª£t
        const periods = buildMultiEventList(events || {});
        historyLastPeriods = periods;
        renderMultiEventCard(periods);

        // th·ªëng k√™ b·ªï sung
        const stats = computeHistoryStats(historyData);
        historyLastStats = stats;
        updateAdditionalStats(stats);

        document.getElementById("historyStatsCard").style.display = "block";
      })
      .catch((err) => {
        console.error(err);
        if (info) info.textContent = "L·ªói t·∫£i d·ªØ li·ªáu.";
      });
    }

    /* =====================================================
       EXPORT CSV
    ===================================================== */
    function exportHistoryCSV() {
      if (!historyLastRows || historyLastRows.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t. H√£y ch·ªçn tr·∫°m v√† ng√†y.");
        return;
      }

      const header = [
        "datetime",
        "water_level_cm",
        "road_flood_cm",
        "rise_rate_cm_per_min",
        "fall_rate_cm_per_min",
        "over_sidewalk",
        "flood_duration_min",
      ];

      const rows = [header, ...historyLastRows];
      const csv = rows.map((r) => r.join(",")).join("\n");

      const blob = new Blob([csv], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);

      const stationSelect = document.getElementById("historyStationSelect");
      const dateInput = document.getElementById("historyDate");

      const filename = `history_${stationSelect.value}_${dateInput.value}.csv`;

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
    }
/* ============================================
   MARKER THEO flood_level (0‚Äì3)
============================================ */
function createOrUpdateMarker(id, s) {
  if (!s || !s.lat || !s.lng) return;

  const level = Number(s.flood_level ?? 0);

  // M√†u theo m·ª©c ng·∫≠p
  let color = "#4ade80";  // an to√†n
  if (level === 1) color = "#3b82f6";
  else if (level === 2) color = "#f97316";
  else if (level >= 3) color = "#ef4444";

  // Nh·∫•p nh√°y n·∫øu ng·∫≠p n·∫∑ng
  const blink = level >= 3 ? "animation: pulseBlink 1s infinite;" : "";

  const html = `
    <div class="dyn-marker-outer" style="${blink}">
      <div class="dyn-marker-inner" style="background:${color};"></div>
    </div>
  `;

  const icon = L.divIcon({
    className: "",
    html,
    iconSize: [26, 26],
    iconAnchor: [13, 13]
  });

  const latlng = [s.lat, s.lng];

  if (!markers[id]) {
    markers[id] = L.marker(latlng, { icon }).addTo(map);
    markers[id].on("click", () => showStationPopup(id));
  } else {
    markers[id].setLatLng(latlng);
    markers[id].setIcon(icon);
  }
}


    /* =====================================================
       EXPORT PDF (B√ÅO C√ÅO NG√ÄY ‚Äì TYPE 1)
    ===================================================== */
    function exportHistoryPDF() {
      if (!historyLastRows || historyLastRows.length === 0) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t. H√£y ch·ªçn tr·∫°m v√† ng√†y.");
        return;
      }

      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán PDF (jsPDF).");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "mm", "a4");

      const stationSelect = document.getElementById("historyStationSelect");
      const dateInput = document.getElementById("historyDate");
      const stationText =
        stationSelect.options[stationSelect.selectedIndex].text || stationSelect.value;

      // Header
      doc.setFontSize(16);
      doc.text("B√ÅO C√ÅO NG·∫¨P N∆Ø·ªöC", 105, 15, { align: "center" });

      doc.setFontSize(11);
      doc.text(`Tr·∫°m: ${stationText}`, 14, 25);
      doc.text(`Ng√†y: ${dateInput.value}`, 14, 32);

      // Stats
      let y = 42;
      const stats =
        historyLastStats ||
        computeHistoryStats(
          Object.fromEntries(
            historyLastRows.map((r) => {
              const dt = r[0].split(" ")[1] || "";
              return [dt, { water_level: Number(r[1] || 0) }];
            })
          )
        );

      doc.text(`ƒê·ªô s√¢u trung b√¨nh: ${stats.avgDepth.toFixed(1)} cm`, 14, y);
      y += 6;
      doc.text(`Th·ªùi gian ng·∫≠p (ph√∫t): ${stats.floodDuration}`, 14, y);
      y += 8;

      // N·∫øu c√≥ nhi·ªÅu ƒë·ª£t, in t√≥m t·∫Øt 3 ƒë·ª£t ƒë·∫ßu
      if (historyLastPeriods && historyLastPeriods.length > 0) {
        doc.text("C√°c ƒë·ª£t m∆∞a/ng·∫≠p:", 14, y);
        y += 5;
        historyLastPeriods.slice(0, 3).forEach((p, idx) => {
          doc.text(
            `ƒê·ª£t ${idx + 1}: Bƒê m∆∞a ${formatTS(p.rainStart)}, Bƒê ng·∫≠p ${formatTS(
              p.floodStart
            )}, HM ${formatTS(p.rainEnd)}, HN ${formatTS(p.floodEnd)}`,
            14,
            y
          );
          y += 5;
        });
        y += 2;
      }

      // Table header
      doc.setFontSize(10);
      if (y < 60) y = 60;
      doc.text("Th·ªùi gian", 14, y);
      doc.text("M·ª±c n∆∞·ªõc (cm)", 55, y);
      doc.text("Ng·∫≠p m·∫∑t ƒë∆∞·ªùng", 105, y);
      y += 4;
      doc.setLineWidth(0.1);
      doc.line(14, y, 195, y);
      y += 3;

      historyLastRows.forEach((row) => {
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.text(String(row[0]), 14, y);
        doc.text(String(row[1]), 55, y);
        doc.text(String(row[2]), 105, y);
        y += 5;
      });

      const filename = `report_${stationSelect.value}_${dateInput.value}.pdf`;
      doc.save(filename);
    }

    /* ============================================
       KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
    ============================================ */
    window.onload = function () {
      initMap();
      fetchStations();
      startRealtimeListener();
      console.log("üöÄ H·ªá th·ªëng gi√°m s√°t ng·∫≠p ƒë√£ s·∫µn s√†ng.");
    };

    /* ============================================
       PWA SERVICE WORKER
    ============================================ */
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("/sw.js")
        .then(() => console.log("PWA Service Worker Registered"))
        .catch(console.error);
    }
  </script>
</body>
</html>
